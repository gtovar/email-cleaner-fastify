version: "3.9"
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: email
      POSTGRES_PASSWORD: email
      POSTGRES_DB: email_cleaner
    ports: ["5432:5432"]
    volumes: ["pgdata:/var/lib/postgresql/data"]

  fastapi:
    build:
      context: ./python/classifier
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    ports: ["8000:8000"]
    environment:
      # if needed, pass model paths/envs
    depends_on: ["db"]

  fastify:
    build:
      context: .
    command: npm run dev
    ports: ["3000:3000"]
    environment:
      DATABASE_URL: postgres://email:email@db:5432/email_cleaner
      FASTAPI_URL: http://fastapi:8000
      INTERNAL_JWT_SECRET: change-me
    depends_on: ["db","fastapi"]

  n8n:
    image: n8nio/n8n:latest
    ports: ["5678:5678"]
    environment:
      GENERIC_TIMEZONE: America/Monterrey

volumes:
  pgdata:
